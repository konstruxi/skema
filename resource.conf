# A scaffold of rest interface



location ~* /(?<preset>new)$ {
  include '/root/konstruxi/skema/conf/meta.conf';
  # New
  postgres_query   GET "SELECT 'Create new ' || singularize('$resource')      as title,
                               'Create'                                       as label";
  postgres_rewrite GET rows fieldset.html;
  
}


location ~* /(?<id>\d+)/(?<preset>edit)$ {
  include '/root/konstruxi/skema/conf/meta.conf';
  # Edit
  postgres_query   GET "WITH row as (SELECT * from $resource where id=$id)        
                        SELECT row_to_json(row)                               as item,
                               'Edit ' || singularize('$resource')            as title,  
                               'Update'                                       as label
                        FROM row";
  postgres_rewrite GET HEAD rows fieldset.html;
  postgres_rewrite GET HEAD no_rows 404;
}


location ~* /(?<id>\d+)/undo$ {
  include '/root/konstruxi/skema/conf/meta.conf';
  # Edit
  postgres_query   GET "SELECT delete_and_return_new('$resource', $1)";
  postgres_rewrite GET HEAD no_rows /$resource/?undo=/$resource/$id&flash=You%20undid%20it%20-%20it%20is%20now%20deleted;
  postgres_rewrite GET HEAD no_errors /$resource/:id/?redo=/$resource/:id;
}
location ~* /(?<id>\d+)/$ {
  include '/root/konstruxi/skema/conf/meta.conf';
  set_form_input_json $params;


  # Show
  postgres_query   GET ":WITH row as (SELECT * from ${resource}_current where root_id=:i:id or id=:i:id ORDER by id DESC LIMIT 1) 
                        SELECT 'View ' || row.id                           as title, 
                               row_to_json(row)                               as item
                        FROM row";
  postgres_rewrite GET rows    fields.html;
  postgres_rewrite GET no_rows 404;

  # Destroy
  postgres_query   DELETE "DELETE from $resource where id = $id";
  postgres_rewrite DELETE changes    /$resource/;
  postgres_rewrite DELETE no_changes 404;

  # Update
  postgres_query   POST PUT  ":WITH  new as (:@:patch_sql 
                                             FROM json_populate_record(NULL::$resource, 
                                               convert_arrays(json_extract_path(:j:params, singularize(:resource)))) new 
                                             RETURNING *)
 
                              SELECT 'Editing ' || singularize(:resource)     as title,
                                     row_to_json(new)                         as item,
                                     'Update again'                           as label,
                                     'Updated ' || singularize(:resource) 
                                                ||' successfully.'            as success,
                                     'Some ' || singularize(:resource) 
                                                ||' information is not valid.'as flash
                              FROM new";
  postgres_rewrite POST PUT errors    fields.html;
  postgres_rewrite POST PUT no_errors /$parent_resource/$parent_id/$resource/:id/?flash=:success;

}

location ~* /$ {
  include '/root/konstruxi/skema/conf/meta.conf';
  set_form_input_json $params;

  # Index
  postgres_query   GET ":SELECT 
                          'Browse ' || :resource as title,
                          json_agg(r)              as items 
                        FROM(
                          :@:select_sql
                          ORDER BY id DESC
                          LIMIT 10) r;";
  postgres_rewrite GET rows orders.html;

  # Create
  postgres_query   POST  ":WITH new as (:@:insert_sql 
                                        FROM json_populate_record(NULL::$resource, 
                                          convert_arrays(json_extract_path(:j:params, singularize(:resource)))) new
                                        RETURNING *)
                            
                          SELECT 'New ' || singularize(:resource)    as title, 
                                 'Created ' || singularize(:resource)    
                                            ||' successfully.'                as success,
                                 row_to_json(new)                             as item,
                                'Try again'                                   as label 
                          FROM new";
  postgres_rewrite POST errors fieldset.html;
  postgres_rewrite POST no_errors /$grandparent_resource/$grandparent_id/$parent_resource/$parent_id/$resource/:id/?flash=:success;

}
