location ~* ^/(?:(?<realm>api)/v1/)?(?:(?:(?:(?<resource3>[a-z0-9_-]+)/(?<slug3>[a-z0-9_-]+)/)?(?<resource2>[a-z0-9_-]+)/(?<slug2>[a-z0-9_-]+)/)?(?<resource>[a-z0-9_-]+))/(?<slug>[a-z0-9_-]+)/display.?(?<format>json|html?|ext.json)?$ {
  include app/mixins/upstream.conf;

  # Show
  postgres_query   GET :display;
  postgres_rewrite GET rows    display.html;
  postgres_rewrite GET no_rows 404;

}

location ~* ^/(?:(?<realm>api)/v1/)?(?:(?:(?:(?<resource3>[a-z0-9_-]+)/(?<slug3>[a-z0-9_-]+)/)?(?<resource2>[a-z0-9_-]+)/(?<slug2>[a-z0-9_-]+)/)?(?<resource>[a-z0-9_-]+))/(?<slug>[a-z0-9_-]+)/undo$ {
  include app/mixins/upstream.conf;
  include app/mixins/redirect.conf;

  # Undo
  postgres_query   GET :undo;
  postgres_rewrite GET HEAD no_rows $return_path?redo=$return_path%3F$id&flash=You%20undid%20it%20-%20it%20is%20now%20deleted;
  postgres_rewrite GET HEAD rows $return_path:slug/?redo=$return_path%3F:slug&flash=You%20undid%20it%20-%20rolled%20to%20previous%20version;
}

location ~* ^/(?:(?<realm>api)/v1/)?(?:(?:(?:(?<resource3>[a-z0-9_-]+)/(?<slug3>[a-z0-9_-]+)/)?(?<resource2>[a-z0-9_-]+)/(?<slug2>[a-z0-9_-]+)/)?(?<resource>[a-z0-9_-]+))/(?<slug>[a-z0-9_-]+)/(?<filename>[a-zA-Z0-9-_]+\.[a-zA-Z0-9][a-zA-Z0-9][a-zA-Z0-9]?[a-zA-Z0-9]?)$ {
  include app/mixins/upstream.conf;

  more_set_headers 'Content-Type: $auto_content_type';
  # Undo
  postgres_query   GET :file;
  postgres_output hex;

  #break;
}